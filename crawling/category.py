from bs4 import BeautifulSoup
from selenium import webdriver
import re
import json
import ast
import pymysql.cursors

# 드라이버 설정
options = webdriver.ChromeOptions()
options.add_argument('headless')
options.add_argument('window-size=1920x1080')
options.add_argument("disable-gpu")

chrome_driver_path = 'C:/Users/SAMSUNG/Downloads/chromedriver_win32/chromedriver.exe'
driver = webdriver.Chrome(chrome_driver_path,  chrome_options=options)
driver.implicitly_wait(3)

#상품 id 목록
product_id = [ '30432998','1017008148','2459456198','1978909970','60937795','1522475374','1988820436','3059633','2409735325','8840192','186774740',
               '1057474966','2426064755','1709518944','1434474102','2462512601','41119945','748083957','2423633084','2450593925','2471993196','2435669515','2039250220',
               '2459346058','1270463397','786230245','2434469822','2368346692','2421935894','2395835000','2381790838','2420822164','1700597803','2397203559','1124027418',
               '2373908150','2364883905','2390159074','2371231210','2445871452','2407705648','2375520198','2439300227','2078801694','2345426253','2392324302','1967132239',
               '2382916876','1856319504','1899306059','1306404063','1236879639','412482241','1766878207','1306404063','1436826869','2410444031','2100286290','2461911541','1487675157',
               '1166358755','2214502602','1679741579','2107859509','1465997983','2336766878','2198911704','2126828599','1733642304','1954136407','110397986','2217389058',
               '1833492575','2059243168','106598793','81447566','142019339','608750373','1453335029','148298786','2177923925','2348017873','1470964507','142578216','286582659',
               '1300337873','2415780474','156095570','175354224','58575631','152445627','286601199','1616598459','2470803274','1343874682','1119964027','1977953143','2177934431',
               '832124076','2124171724','2336766878','2341784903','248329991','1658511114','1130471176','1130679126','1955684853','2043381666','1242620330',
               '14129013','2421930203','2214911420','602904262','2319996891','2406950987','796247461','820255150','54150416','1788295032','86899719','1065082805','1684537568',
               '1684537568','1065316907','1443435844','1127541141','85552030','567202245','567202245','2319996891','1173558823','1698091418','490333290','16954640','14708455',
               '1878082899','16983949','2258948125','1197219729','1979883393','1872292454','2346303523','2190437266','54150416','1779030549','2418637376','1857172300',
               '1164974120','1516201127','1444409522','2038464407','820255150','368805752','1779030549','2319996891','1770919141','1443435844','2370547699','1255229793',
               '1006542','1567731741','2555593319','1582758351','1487678688','1350259768','2248396230',
               '2435582233','1676108423','2459334462','1409918456','1527780447','2516257890','2339074037','2386389981','786092814',
               '1134877208','1516602141','80659589','286582659','1718864143','767479579','142578216','1406735575',
               '19015293','97951629','1485026251','80739333','1406735575','2555580390','1437108439','1595783629',
               '1213820186','1231220577','1774217869','2169260239','1287039133','1652648933','2136860723','449370932','2383651361',
               '1805529477','1748893368','2423996673','700625477','2544186121','1680608842','17807434','1437861102','1293929125',
               '2554584234','1891870528','1443293443','2570759935','2570871974','2418385362','496755049','1563270643','38168884','1131760352',
               '1508027664','1486946425','2527932690','2543587595','2569307739','2567929601','2571487110','2570410241','1891870794',
               '2342532763','2571499168','2568585378','2571516439','2552342072','2571669392','2571416736','1263772182','1500126583','2569573888',
               '1223384973','2571259735','2571413991','2383732083','189236553',
               '1455718052','1355025883','2355004619','2494518334','390971109','975629171','1942629375','2569629484','2564525562',
               '2529486814','526247809','143339833','1446736942','185144673','1116123128','827707902','1571073370','2118060124',
               '827312225','2567063592','2567063592','2164650922','1970064606','2524261378','41686160','2044062312','1004852394','1543710867','2561406523',
               '1984048999','2311811877','2537964232','2517031249','1980744464','2322446535','2329247940','361102851','2536243572','1228327675','2546038637',
               '2563530668','1657513612','1254598940','1651822964','1452592762','797893777','1381989763','1381989763','991310147','2568861544',
               '2544008247','2543656276','1008570781','2570927175','2569631946','1918328509','2561000004','2568693930','2434737049','2299839253',
               '2571508658','90336998','1129368529','1580925721','2393864400']

for x in product_id:
    # url 설정
    url_r = 'http://www.11st.co.kr/product/SellerProductDetail.tmall?method=getSellerProductDetail&prdNo='
    url_id = x
    url = url_r + url_id

    # url 접근
    driver.get(url)
    soup = BeautifulSoup(driver.page_source, 'html.parser')

    # 크롤링 시작 - 해당 iframe 접근
#    editor_frame = driver.find_element_by_id("prdDescIfrm")
#    driver.switch_to_frame(editor_frame)
    html = driver.page_source

    #정규표현식으로 리스트에 접근
    matched = re.search(r'var rakeLogPageInfo = (.*);', html)

    if not matched :
        continue
    optList = matched.group(1)

    #json을 output_list에 삽입
    output_list = json.loads(optList)

    #카테고리정보 있는 객체로 접근
    output = output_list['PageInfo']
    print(output)

    #추출
    large_category_name = output['large_category_name'] #카테고리 1
    middle_category_name = output['middle_category_name'] #카테고리 2
    small_category_name = output['small_category_name'] #카테고리 3
    detail_category_name = output['detail_category_name'] #카테고리 4
    print(large_category_name)
    print(middle_category_name)
    print(small_category_name)
    print(detail_category_name)

    #리스트화
    category =large_category_name+","+middle_category_name+","+small_category_name+","+detail_category_name
    
    print(category)

    conn = pymysql.connect(host='18.191.10.193',
        user='kimcheon',
        password='kim2cheon1',
        db='SHOWOOMI',
        charset='utf8')
    try:
        with conn.cursor() as cursor:
            sql = "update Product set category = %s where productId = %s"
            cursor.execute(sql, (category,url_id,))
            conn.commit()
            print(cursor.lastrowid)
            # 1 (last insert id)
    finally:
            conn.close()
        #print('{optValueNo} {retDtlExtNm}'.format(**output))
    
    
        
        

    
        
            
 






